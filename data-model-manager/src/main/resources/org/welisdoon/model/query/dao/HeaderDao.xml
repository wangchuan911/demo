<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.welisdoon.model.query.dao.HeaderDao">

    <resultMap id="rm_AbstractHeaderEntity" type="org.welisdoon.model.query.entity.AbstractHeaderEntity">
        <discriminator javaType="boolean" column="IS_LEAF">
            <case value="true" resultMap="rm_SimpleHeaderEntity"></case>
            <case value="false" resultMap="rm_GroupHeaderEntity"></case>
        </discriminator>

    </resultMap>
    <resultMap id="rm_GroupHeaderEntity" type="org.welisdoon.model.query.entity.header.GroupHeaderEntity"
               extends="rm_SimpleHeaderEntity">
        <association property="children" column="{parentHeadId=ID   }"
                     select="org.welisdoon.model.query.dao.HeaderDao.list"></association>
    </resultMap>
    <resultMap id="rm_SimpleHeaderEntity" type="org.welisdoon.model.query.entity.header.SimpleHeaderEntity">
        <id property="id" column="ID"></id>
        <result property="name" column="NAME"></result>

        <result property="code" column="CODE"></result>
        <result property="linkId" column="LINK_ID"></result>
    </resultMap>
    <select id="get" parameterType="long"
            resultMap="rm_AbstractHeaderEntity">
        select A.*,
        <include refid="is_leaf"></include>
        from DM_QUERY_HEADER A
        where A.ID = #{value}
    </select>
    <select id="list" parameterType="org.welisdoon.model.query.entity.condition.QueryHeaderCondition"
            resultMap="rm_AbstractHeaderEntity">
        SELECT A.*,
        <include refid="is_leaf"></include>
        FROM DM_QUERY_HEADER A
        <where>
            <if test="queryId!=null">
                AND A.QUERY_ID=#{queryId}
            </if>
            <choose>
                <when test="parentHeadId!=null">
                    AND A.PARENT_ID=#{parentHeadId}
                </when>
                <otherwise>AND A.PARENT_ID=0</otherwise>
            </choose>
        </where>

    </select>
    <sql id="is_leaf">
            (case when link_id is not null and link_id != 0 then true else false end)
            is_leaf
    </sql>

</mapper>
